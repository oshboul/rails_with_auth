# Welcome to rails_with_auth
## Overview
rails_with_auth is a minimal Rails application demonstrating authentication functionality. It is inspired by the [`rails generate authentication`](https://guides.rubyonrails.org/security.html) command but has been customized to suit a more streamlined use case. The app supports sign-in and sign-up via email and multiple third-party providers, including Google, Facebook, LinkedIn, and Reddit.

This project focuses on basic sign-in/up functionality with minimal setup and does not prioritize validations or best practices. It uses cookie-based sessions for authentication, with no database storage for session data.

This solution does not require any external authentication gems but leverages Rails' built-in capabilities along with OmniAuth for third-party authentication.
## Code Explanation
### Models
1. **User:** This model represents the user and stores their basic information, such as `id` and `password_digest`. The `password_digest` field is only required if the user signs up with email and is used for securely storing the password hash.
2. **UserAuthentication:** This model connects users with an authentication method, whether it is an email, or a third-party providers (Google, Facebook, LinkedIn, Reddit). It stores the `user_id`, `provider` (e.g., google), and `external_id` (the UID received from the provider) to allow users to sign in via multiple authentication methods.
---
### Controllers
1. **JoinController:** This controller is responsible for handling the initial sign-in and sign-up actions.
    * `index`: This action renders the page where users can either sign in using their email or choose a third-party authentication provider.
2. **AuthController:**
    * `email_sign_in`: This action processes the sign-in request by matching the entered email and password with the records in the database.
    * `email_sign_up`: This action handles the sign-up process, where a user provides an email and password, and new records (user and user_authentication) are created in the database.
    * `provider_callback`: This action handles the OAuth callback from third-party providers like Google, Facebook, LinkedIn, and Reddit. Once the authentication provider redirects back to the app, this action is called to find or create the user using the provider's `external_id`.
    * `logout`: This action is used to log out the user by deleting their session.
3. **HomeController:**
    * `index`: Once the user is authenticated (via either email or a third-party provider), they are redirected to the home page. This page displays the method used to sign-in.
---
### Controllers/Concerns
1. **Authentication:** This module is a reusable Rails concern designed to manage user authentication seamlessly across controllers. It is inspired by the [concern](https://github.com/rails/rails/blob/main/railties/lib/rails/generators/rails/authentication/templates/app/controllers/concerns/authentication.rb.tt) generated by `rails generate authentication` but is intentionally kept simpler for better maintainability and understanding. Additionally, it supports multiple authentication methods per user by utilizing the `UserAuthentication` model.
    * **Key Features:**
        * **Automatic Authentication Enforcement:** The module automatically enforces authentication for all actions by including the `before_action :require_authentication` callback.
        * **Flexible Access Control:** Controllers can selectively bypass authentication requirements using the `allow_unauthenticated_access` class method.
        * **Helper Method:** The `authenticated?` helper method is exposed, allowing execute conditional logic based on the user's authentication state.
        * **Session Management:** The `resume_session` method retrieves the current user's authentication from the session and stores it in the `Current` object, allowing access throughout the request lifecycle.
        * **Session Lifecycle Control:**
          * `start_new_session_for(user_authentication)` Initiates a new session for the authenticated user and redirects to the root URL.
          * `terminate_session` Clears the session and redirects the user to the join (sign-in) page.

#### This concern provides a streamlined and maintainable approach to authentication by centralizing session management and access control logic while maintaining flexibility for public-facing actions. It is ideal for applications needing to support multiple authentication providers while keeping the implementation clean and straightforward.
---
### Initializers
1. **omniauth.rb:**
    * `Rails.application.config.middleware.use OmniAuth::Builder do`: This line initializes OmniAuth and adds it to the Rails middleware stack.
    * `provider(:provider_name, ACCESS_KEY, SECRET_KEY, options)`:
      * `provider_name`: Such as google_oauth2, facebook, etc. [Here](https://github.com/omniauth/omniauth/wiki/List-of-Strategies) is a wide list of many providers
      * `ACCESS_KEY` and `SECRET_KEY`: The keys for authenticating you project with the provider
      * `options`:
        * They vary from provider to another, the `scope` option is used by majority of providers, it determines which data related to the user you will receive (username, email, profile pic, etc.)
        * `redirect_uri` is one of the most important options, by default for all providers will be like `http://localhost:3000/auth/:provider_name/callback` and it MUST match the redirect uri that set in each provider's developer console. `redirect_uri` may be named with `callback_url` or `redirect_url`. Check your provider to know the proper option name.
---
### Routes
We’ll skip the standard routes commonly found in any Rails app and focus on these new ones:
```
post "auth/google_oauth2", as: :google_oauth2_sign_in
post "auth/facebook", as: :facebook_sign_in
post "auth/linkedin", as: :linkedin_sign_in
post "auth/reddit", as: :reddit_sign_in
```
#### As you can see, these routes do not point to any controller actions. Instead, the `OmniAuth::Builder` middleware intercepts the requests right after the routes and before they reach any controllers. It then forwards them to the provider to handle the authentication process. Additionally, it is worth noting that you can use these routes with `get`
---
### Gemfile
Just like with the routes, we’ll skip the familiar gems and focus on the new ones.
```
gem "omniauth-rails_csrf_protection"
gem "omniauth-google-oauth2"
gem "omniauth-facebook"
gem "omniauth-linkedin-openid"
gem "omniauth-reddit"
```
* **omniauth-rails_csrf_protection:** This gem is required if you are using the auth routes with `POST`. If you are using `GET`, it can be omitted.
* Other gems simply enable you to use the providers within the `OmniAuth::Builder` middleware.
---
### Sessions
#### This app uses cookie-based sessions to track authenticated users. The session information (such as the user_authentication ID) is stored in the browser cookies, ensuring the user stays logged in across requests. The sessions are not stored in the database, making the authentication process lighter and simpler.
---
### Coming Soon
* Allow adding multi-providers per single user
* Use it with APIs
